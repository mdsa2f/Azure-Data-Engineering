{
	"name": "upsert_logic",
	"properties": {
		"folder": {
			"name": "src/loading"
		},
		"content": {
			"query": "--SET IDENTITY_INSERT dim_captadores ON;\n\n--SELECT * FROM dim_tipos_polen;\n\n--TRUNCATE TABLE dim_tipos_polen;\n\nCREATE TABLE stg_tipos_polen (\n    codigo NVARCHAR(64),\n    descripcion NVARCHAR(512)\n);\n\nCOPY INTO stg_tipos_polen (\n    codigo,\n    descripcion\n)\nFROM 'https://stazdatengtfg.dfs.core.windows.net/data/cleaned/descripciones_polen'\nWITH (\n    FILE_TYPE = 'PARQUET'\n);\n\nUPDATE target\nSET target.descripcion = source.descripcion\nFROM dim_tipos_polen target\nJOIN stg_tipos_polen source\n    ON target.codigo = source.codigo;\n\nINSERT INTO dim_tipos_polen (codigo, descripcion)\nSELECT codigo, descripcion\nFROM stg_tipos_polen\nWHERE codigo NOT IN (SELECT codigo FROM dim_tipos_polen);\n\n/*MERGE dim_tipos_polen AS target\nUSING stg_tipos_polen AS source\nON target.codigo = source.codigo\n\nWHEN MATCHED THEN\n    UPDATE SET\n        target.descripcion = source.descripcion\n\nWHEN NOT MATCHED THEN\n    INSERT (codigo, descripcion)\n    VALUES (source.codigo, source.descripcion);\n*/\n\nDROP TABLE stg_tipos_polen;\n\n\n\n\n\n\n\n--SET IDENTITY_INSERT dim_captadores OFF;\n\n--SELECT * FROM dim_captadores;\n\n--TRUNCATE TABLE dim_captadores;\n\nCREATE TABLE stg_captadores (\n    codigo VARCHAR(64),\n    nombre VARCHAR(255),\n    descripcion VARCHAR(255),\n    url_infoweb VARCHAR(255),\n    direccion_localidad VARCHAR(255),  \n    direccion_ubicacion VARCHAR(255),\n    direccion_codigo_postal INT,\n    zbs_geocodigo INT,\n    zbs_nombre VARCHAR(255),\n    fecha_inicio_mediciones VARCHAR(64),\n    numero_tipos_de_polen_registrados INT,\n    tipos_de_polen_registrados VARCHAR(255),\n    altura_del_captador FLOAT,\n    altitud FLOAT,\n    x_epsg25830 FLOAT,\n    y_epsg25830 FLOAT,\n    lat_epsg4258 FLOAT,\n    long_epsg4258 FLOAT,\n    red_esp_aerobiologia BIT,\n    url_calendario_polinico VARCHAR(255),  \n    edificio VARCHAR(255), \n    departamento_responsable VARCHAR(255), \n    contacto_email VARCHAR(255),\n    tipo_titularidad VARCHAR(255)\n);\n\nCOPY INTO stg_captadores\n    (codigo,\n    nombre,\n    descripcion,\n    url_infoweb,\n    direccion_localidad,\n    direccion_ubicacion,\n    direccion_codigo_postal,\n    zbs_geocodigo,\n    zbs_nombre,\n    fecha_inicio_mediciones,\n    numero_tipos_de_polen_registrados,\n    tipos_de_polen_registrados,\n    altura_del_captador,\n    altitud,\n    x_epsg25830,\n    y_epsg25830,\n    lat_epsg4258,\n    long_epsg4258,\n    red_esp_aerobiologia,\n    url_calendario_polinico,\n    edificio,\n    departamento_responsable,\n    contacto_email,\n    tipo_titularidad)\nFROM 'https://stazdatengtfg.dfs.core.windows.net/data/cleaned/captadores'\nWITH (\n    FILE_TYPE = 'PARQUET'\n);\n\nUPDATE target\nSET target.nombre = source.nombre,\n    target.descripcion = source.descripcion,\n    target.url_infoweb = source.url_infoweb,\n    target.direccion_localidad = source.direccion_localidad,\n    target.direccion_ubicacion = source.direccion_ubicacion,\n    target.direccion_codigo_postal = source.direccion_codigo_postal,\n    target.zbs_geocodigo = source.zbs_geocodigo,\n    target.zbs_nombre = source.zbs_nombre,\n    target.fecha_inicio_mediciones = source.fecha_inicio_mediciones,\n    target.numero_tipos_de_polen_registrados = source.numero_tipos_de_polen_registrados,\n    target.tipos_de_polen_registrados = source.tipos_de_polen_registrados,\n    target.altura_del_captador = source.altura_del_captador,\n    target.altitud = source.altitud,\n    target.x_epsg25830 = source.x_epsg25830,\n    target.y_epsg25830 = source.y_epsg25830,\n    target.lat_epsg4258 = source.lat_epsg4258,\n    target.long_epsg4258 = source.long_epsg4258,\n    target.red_esp_aerobiologia = source.red_esp_aerobiologia,\n    target.url_calendario_polinico = source.url_calendario_polinico,\n    target.edificio = source.edificio,\n    target.departamento_responsable = source.departamento_responsable,\n    target.contacto_email = source.contacto_email,\n    target.tipo_titularidad = source.tipo_titularidad\nFROM dim_captadores target\nJOIN stg_captadores source\n    ON target.codigo = source.codigo;\n\nINSERT INTO dim_captadores \n    (codigo, nombre, descripcion, url_infoweb, direccion_localidad, direccion_ubicacion,\n    direccion_codigo_postal, zbs_geocodigo, zbs_nombre, fecha_inicio_mediciones,\n    numero_tipos_de_polen_registrados, tipos_de_polen_registrados, altura_del_captador,\n    altitud, x_epsg25830, y_epsg25830, lat_epsg4258, long_epsg4258, red_esp_aerobiologia,\n    url_calendario_polinico, edificio, departamento_responsable, contacto_email, tipo_titularidad)\nSELECT codigo, nombre, descripcion, url_infoweb, direccion_localidad, direccion_ubicacion,\n    direccion_codigo_postal, zbs_geocodigo, zbs_nombre, fecha_inicio_mediciones,\n    numero_tipos_de_polen_registrados, tipos_de_polen_registrados, altura_del_captador,\n    altitud, x_epsg25830, y_epsg25830, lat_epsg4258, long_epsg4258, red_esp_aerobiologia,\n    url_calendario_polinico, edificio, departamento_responsable, contacto_email, tipo_titularidad\nFROM stg_captadores source\nWHERE source.codigo NOT IN (SELECT codigo FROM dim_captadores);\n\nDROP TABLE stg_captadores;\n\n\n\n\n--SELECT * FROM fact_mediciones;\n--SELECT * FROM staging_mediciones;\n\n--select count(*) from fact_mediciones;\n\n--TRUNCATE TABLE fact_mediciones;\n--TRUNCATE TABLE staging_mediciones;\n\nCREATE TABLE aux_staging_mediciones (\n    tipo_polen_codigo VARCHAR(64),\n    captador_codigo VARCHAR(64),\n    granos_polen_metro_cubico INT,\n    fecha_lectura VARCHAR(64)\n);\n\nCOPY INTO aux_staging_mediciones\n    (tipo_polen_codigo, captador_codigo, granos_polen_metro_cubico, fecha_lectura)\nFROM 'https://stazdatengtfg.dfs.core.windows.net/data/cleaned/mediciones'\nWITH (\n    FILE_TYPE = 'PARQUET'\n);\n\nUPDATE target\nSET target.granos_polen_metro_cubico = source.granos_polen_metro_cubico\nFROM staging_mediciones target\nJOIN aux_staging_mediciones source\n    ON target.tipo_polen_codigo = source.tipo_polen_codigo\n    AND target.captador_codigo = source.captador_codigo\n    AND CAST(target.fecha_lectura AS DATE) = CAST(source.fecha_lectura AS DATE);\n\nINSERT INTO staging_mediciones (tipo_polen_codigo, captador_codigo, granos_polen_metro_cubico, fecha_lectura)\nSELECT tipo_polen_codigo, captador_codigo, granos_polen_metro_cubico, fecha_lectura\nFROM aux_staging_mediciones source\nWHERE NOT EXISTS (\n    SELECT 1\n    FROM staging_mediciones target\n    WHERE target.tipo_polen_codigo = source.tipo_polen_codigo\n    AND target.captador_codigo = source.captador_codigo\n    AND CAST(target.fecha_lectura AS DATE) = CAST(source.fecha_lectura AS DATE)\n);\n\nDROP TABLE aux_staging_mediciones;\n\n\n\nTRUNCATE TABLE fact_mediciones;\n\nINSERT INTO fact_mediciones (tipo_polen_id, captador_id, granos_polen_metro_cubico, fecha_lectura)\nSELECT t.id, c.id, s.granos_polen_metro_cubico, s.fecha_lectura\nFROM staging_mediciones s\nINNER JOIN dim_tipos_polen t ON s.tipo_polen_codigo = t.codigo\nINNER JOIN dim_captadores c ON s.captador_codigo = c.codigo;\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "sqlpool",
				"poolName": "sqlpool"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}